<!-- lib/movie_search_web/live/movie_live.html.heex -->
<div class="app-container">
  <h1 class="app-title">🎬 Recherche de Films</h1>
  
  <!-- Panel de recherche et filtres -->
  <div class="search-panel">
    <div class="search-grid">
      <!-- Recherche textuelle -->
      <div class="form-group">
        <label class="form-label">🔍 Rechercher</label>
        <form phx-change="search">
          <input
            type="text"
            name="search[query]"
            value={@search_query}
            placeholder="Titre, réalisateur, genre..."
            class="form-input"
          />
        </form>
      </div>
      
      <!-- Filtre par genre -->
      <div class="form-group">
        <label class="form-label">🎭 Genre</label>
        <select
          phx-change="filter_genre"
          name="genre"
          class="form-select"
        >
          <option value="">Tous les genres</option>
          <%= for genre <- @genres do %>
            <option value={genre} selected={@selected_genre == genre}><%= genre %></option>
          <% end %>
        </select>
      </div>
      
      <!-- Filtre par note -->
      <div class="form-group">
        <label class="form-label">⭐ Note minimale</label>
        <select
          phx-change="filter_rating"
          name="rating"
          class="form-select"
        >
          <option value="0">Toutes</option>
          <option value="8.0" selected={@min_rating == 8.0}>8.0+</option>
          <option value="8.5" selected={@min_rating == 8.5}>8.5+</option>
          <option value="9.0" selected={@min_rating == 9.0}>9.0+</option>
        </select>
      </div>
      
      <!-- Tri -->
      <div class="form-group">
        <label class="form-label">📊 Trier par</label>
        <select
          phx-change="sort"
          name="sort_by"
          class="form-select"
        >
          <option value="title" selected={@sort_by == "title"}>Titre</option>
          <option value="year" selected={@sort_by == "year"}>Année</option>
          <option value="rating" selected={@sort_by == "rating"}>Note</option>
          <option value="duration" selected={@sort_by == "duration"}>Durée</option>
        </select>
      </div>
    </div>
    
    <!-- Actions -->
    <div class="search-actions">
      <p class="results-count">
        <strong><%= @total_items %></strong> film(s) trouvé(s)
        <%= if @total_items > 0 do %>
          - Affichage de <%= start_item_number(@current_page, @items_per_page) %> 
          à <%= end_item_number(@current_page, @items_per_page, @total_items) %>
        <% end %>
      </p>
      
      <div class="action-buttons">
        <%= if @imdb_loading do %>
          <div class="imdb-progress">
            <span>🔧 Réparation en cours... <%= @imdb_progress %>%</span>
            <div class="progress-bar">
              <div class="progress-fill" style={"width: #{@imdb_progress}%"}></div>
            </div>
          </div>
        <% else %>
          <button
            phx-click="check_missing_images"
            class="imdb-button"
            title="Vérifie et retélécharge les images manquantes"
          >
            🔧 Réparer Images
          </button>
        <% end %>
        
        <button
          phx-click="reset_filters"
          class="reset-button"
        >
          🔄 Réinitialiser
        </button>
      </div>
    </div>
  </div>

  <!-- Section formulaires -->
  <div id="movie-form" class="add-movie-section">
    <!-- Bouton d'ajout - seulement si aucun formulaire ouvert -->
    <%= if @form_mode == :closed do %>
      <button
        phx-click="show_add_form"
        class="add-movie-button"
      >
        ➕ Ajouter un Film
      </button>
    <% end %>
    
    <!-- Formulaire d'ajout -->
    <%= if form_is_add?(@form_mode) do %>
      <div class="add-movie-form">
        <div class="form-header">
          <h3>➕ Ajouter un Nouveau Film</h3>
          <button phx-click="close_form" class="close-button">✖</button>
        </div>
        
        <!-- Erreurs de validation -->
        <%= if has_errors?(@form_errors) do %>
          <div class="form-errors">
            <%= for error <- @form_errors do %>
              <p class="error-message">⚠️ <%= error %></p>
            <% end %>
          </div>
        <% end %>
        
        <form phx-submit="add_movie">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">🎬 Titre</label>
              <input
                type="text"
                name="movie[title]"
                class="form-input"
                placeholder="Ex: Blade Runner"
                required
              />
            </div>
            
            <div class="form-group">
              <label class="form-label">📅 Année</label>
              <input
                type="number"
                name="movie[year]"
                class="form-input"
                placeholder="Ex: 1982"
                min="1900"
                max="2030"
                required
              />
            </div>
            
            <div class="form-group">
              <label class="form-label">🎭 Genre(s)</label>
              <input
                type="text"
                name="movie[genre]"
                class="form-input"
                placeholder="Ex: Sci-Fi, Thriller"
                required
              />
              <small class="form-hint">Séparez par des virgules</small>
            </div>
            
            <div class="form-group">
              <label class="form-label">🎬 Réalisateur</label>
              <input
                type="text"
                name="movie[director]"
                class="form-input"
                placeholder="Ex: Ridley Scott"
                required
              />
            </div>
            
            <div class="form-group">
              <label class="form-label">⭐ Note</label>
              <input
                type="number"
                name="movie[rating]"
                class="form-input"
                placeholder="Ex: 8.1"
                min="0"
                max="10"
                step="0.1"
                required
              />
            </div>
            
            <div class="form-group">
              <label class="form-label">⏱️ Durée (min)</label>
              <input
                type="number"
                name="movie[duration]"
                class="form-input"
                placeholder="Ex: 117"
                min="1"
                required
              />
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">📝 Description</label>
            <textarea
              name="movie[description]"
              class="form-textarea"
              placeholder="Résumé du film..."
              rows="3"
            ></textarea>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="submit-button">💾 Ajouter le Film</button>
            <button type="button" phx-click="close_form" class="cancel-button">
              ❌ Annuler
            </button>
          </div>
        </form>
      </div>
    <% end %>
    
    <!-- Formulaire d'édition -->
    <%= if form_is_edit?(@form_mode) do %>
      <div class="add-movie-form">
        <div class="form-header">
          <h3>✏️ Modifier le Film</h3>
          <button phx-click="close_form" class="close-button">✖</button>
        </div>
        
        <!-- Erreurs de validation -->
        <%= if has_errors?(@form_errors) do %>
          <div class="form-errors">
            <%= for error <- @form_errors do %>
              <p class="error-message">⚠️ <%= error %></p>
            <% end %>
          </div>
        <% end %>
        
        <form phx-submit="update_movie">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">🎬 Titre</label>
              <input
                type="text"
                name="movie[title]"
                class="form-input"
                value={@editing_movie.title}
                required
              />
            </div>
            
            <div class="form-group">
              <label class="form-label">📅 Année</label>
              <input
                type="number"
                name="movie[year]"
                class="form-input"
                value={@editing_movie.year}
                min="1900"
                max="2030"
                required
              />
            </div>
            
            <div class="form-group">
              <label class="form-label">🎭 Genre(s)</label>
              <input
                type="text"
                name="movie[genre]"
                class="form-input"
                value={Enum.join(@editing_movie.genre, ", ")}
                required
              />
              <small class="form-hint">Séparez par des virgules</small>
            </div>
            
            <div class="form-group">
              <label class="form-label">🎬 Réalisateur</label>
              <input
                type="text"
                name="movie[director]"
                class="form-input"
                value={@editing_movie.director}
                required
              />
            </div>
            
            <div class="form-group">
              <label class="form-label">⭐ Note</label>
              <input
                type="number"
                name="movie[rating]"
                class="form-input"
                value={@editing_movie.rating}
                min="0"
                max="10"
                step="0.1"
                required
              />
            </div>
            
            <div class="form-group">
              <label class="form-label">⏱️ Durée (min)</label>
              <input
                type="number"
                name="movie[duration]"
                class="form-input"
                value={@editing_movie.duration}
                min="1"
                required
              />
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">📝 Description</label>
            <textarea
              name="movie[description]"
              class="form-textarea"
              rows="3"
            ><%= @editing_movie.description %></textarea>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="submit-button">💾 Sauvegarder</button>
            <button type="button" phx-click="close_form" class="cancel-button">❌ Annuler</button>
          </div>
        </form>
      </div>
    <% end %>
  </div>



  <!-- Grille des films -->
  <div class="movies-grid">
    <%= for movie <- @movies do %>
      <div class="movie-card">
        <!-- Poster du film -->
        <div class="movie-poster">
          <img
            src={movie.poster}
            alt={movie.title}
            loading="lazy"
          />
        </div>
        
        <!-- Informations du film -->
        <div class="movie-info">
          <h3 class="movie-title"><%= movie.title %></h3>
          
          <div class="movie-meta">
            <span class="movie-year"><%= movie.year %></span>
            <div class="movie-rating">
              <span class="star">⭐</span> 
              <span class="score"><%= movie.rating %></span>
            </div>
          </div>
          
          <p class="movie-director">🎬 Réalisé par <%= movie.director %></p>
          <p class="movie-genres"><%= format_genres(movie.genre) %></p>
          <p class="movie-duration">⏱️ <%= format_duration(movie.duration) %></p>
          <p class="movie-description"><%= movie.description %></p>
        </div>
        
        <div class="action-buttons">
          <button 
            phx-click="show_edit_form" 
            phx-value-id={movie.id} 
            class="edit-button"
          >
            ✏️ Éditer
          </button>
          <button
            phx-click="delete_movie"
            phx-value-id={movie.id}
            data-confirm="Voulez-vous vraiment supprimer ce film ?"
            class="delete-button"
          >
            🗑️ Supprimer
          </button>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Message si aucun film trouvé -->
  <%= if Enum.empty?(@movies) do %>
    <div class="empty-state">
      <div class="icon">🔍</div>
      <h3>Aucun film trouvé</h3>
      <p>Essayez de modifier vos critères de recherche</p>
    </div>
  <% end %>

  <!-- PAGINATION AMÉLIORÉE -->
<%= if @total_pages > 1 do %>
  <div class="pagination-container">
    <div class="pagination">
      <!-- Bouton PREMIER -->
      <%= if @current_page > 1 do %>
        <button 
          phx-click="first_page" 
          class="pagination-button pagination-first"
          title="Première page"
        >
          ‹‹ Premier
        </button>
      <% else %>
        <span class="pagination-button pagination-first disabled">‹‹ Premier</span>
      <% end %>

      <!-- Bouton PRÉCÉDENT -->
      <%= if has_prev_page?(@current_page) do %>
        <button 
          phx-click="prev_page" 
          class="pagination-button pagination-prev"
          title="Page précédente"
        >
          ‹ Précédent
        </button>
      <% else %>
        <span class="pagination-button pagination-prev disabled">‹ Précédent</span>
      <% end %>

      <!-- Numéros de pages -->
      <div class="pagination-numbers">
        <!-- Première page si on est loin du début -->
        <%= if @current_page > 3 do %>
          <button 
            phx-click="goto_page" 
            phx-value-page="1" 
            class="pagination-button pagination-number"
          >
            1
          </button>
          <%= if @current_page > 4 do %>
            <span class="pagination-ellipsis">...</span>
          <% end %>
        <% end %>

        <!-- Pages autour de la page courante -->
        <%= for page <- page_range(@current_page, @total_pages) do %>
          <%= if page == @current_page do %>
            <span class="pagination-button pagination-number current">
              <%= page %>
            </span>
          <% else %>
            <button 
              phx-click="goto_page" 
              phx-value-page={page} 
              class="pagination-button pagination-number"
            >
              <%= page %>
            </button>
          <% end %>
        <% end %>

        <!-- Dernière page si on est loin de la fin -->
        <%= if @current_page < @total_pages - 2 do %>
          <%= if @current_page < @total_pages - 3 do %>
            <span class="pagination-ellipsis">...</span>
          <% end %>
          <button 
            phx-click="goto_page" 
            phx-value-page={@total_pages} 
            class="pagination-button pagination-number"
          >
            <%= @total_pages %>
          </button>
        <% end %>
      </div>

      <!-- Bouton SUIVANT -->
      <%= if has_next_page?(@current_page, @total_pages) do %>
        <button 
          phx-click="next_page" 
          class="pagination-button pagination-next"
          title="Page suivante"
        >
          Suivant ›
        </button>
      <% else %>
        <span class="pagination-button pagination-next disabled">Suivant ›</span>
      <% end %>

      <!-- Bouton DERNIER -->
      <%= if @current_page < @total_pages do %>
        <button 
          phx-click="last_page" 
          class="pagination-button pagination-last"
          title="Dernière page"
        >
          Dernier ››
        </button>
      <% else %>
        <span class="pagination-button pagination-last disabled">Dernier ››</span>
      <% end %>
    </div>

    <!-- Info pagination -->
    <div class="pagination-info">
      Page <%= @current_page %> sur <%= @total_pages %>
    </div>
  </div>
<% end %>
</div>